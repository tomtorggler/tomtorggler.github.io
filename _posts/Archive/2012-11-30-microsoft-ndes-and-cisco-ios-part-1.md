---
layout: post
title: "Microsoft NDES and Cisco IOS – part 1"
date: 2012-11-30 18:13:47 +0100
comments: true
category: Archive
tags: ["Network"]
redirect_from: ["/post/Microsoft-NDES-and-Cisco-IOS-part-1", "/post/microsoft-ndes-and-cisco-ios-part-1"]
author: thomas torggler
---
<!-- more -->
<p>With digital certificates being the de-facto standard for authentication, a handy enrollment model is key (pun intended). Microsoft included it’s NDES or Network Device Enrollment Service as a Role in Windows 2008, it has been available as add-on for Windows 2003, too.</p>  <h2>NDES</h2>  <p>So, NDES sounds pretty cool, but what is it, you may wonder. It’s Microsoft’s implementation of SCEP or Simple Certificate Enrollment Protocol, which is a PKI communication protocol that leverages existing PKCS#10 and #7 technology over HTTP. It provides a simple means of requesting and issuing digital certificates across different devices and vendors.</p>  <h2>Installing NDES on Windows Server 2012</h2>  <p>To use SCEP with your existing ADCS based PKI simply add the Role to the Server that provides CA Web Enrollment. I’m not going through the details of setting up a ADCS based PKI here, that might very well be a topic for a future post, though.</p>  <p>Add the Role using ServerManager or Windows PowerShell:</p>  <p><a href="/assets/archive/image_472.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_470.png" width="244" height="174" /></a> </p>  <p><code>Install-WindowsFeature –Name ADCS-Device-Enrollment</code></p>  <h2>Configuring NDES</h2>  <p>After successful installation of the Role, ServerManager informs you that there is some sort of configuration required for the newly added feature.</p>  <p>An AD user account is required for the NDES service to use. That account must be member of the local IIS_IUSRS group on the NDES Server. I created a user with the name of scep and added it to the group before starting the configuration wizard.</p>  <p>Select the Service Account:</p>  <p><a href="/assets/archive/image_473.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_471.png" width="244" height="180" /></a> </p>  <p>Fill in information required for the RA certificate. What happens here, is that the NDES Server is issued two Registration Authority certificates, which are then used for SCEP:</p>  <p><a href="/assets/archive/image_474.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_472.png" width="244" height="180" /></a> </p>  <p>Configure cryptographic settings for the RA keys:</p>  <p><a href="/assets/archive/image_475.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_473.png" width="244" height="180" /></a> </p>  <p>After reviewing the settings, and clicking “Configure” you will see the RA certificates in the “personal” store of the NDES Server:</p>  <p><a href="/assets/archive/image_476.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_474.png" width="244" height="15" /></a> </p>  <h2>Configure NDES CA settings</h2>  <p>The certificate template used by NDES defaults to “IPSECIntermediateOffline”, that can be changed by modifying the following registry keys:</p>  <p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MSCEP    <br />EncryptionTemplate     <br />GeneralPurposeTemplate     <br />SignatureTemplate</p>  <p>I decide to go with the WebServer template, so I update the registry and restart the “certsvc” service. Keep in mind, that the service-user account (TOMT\scep, in my lab) needs permissions to enroll for the selected certificate template. This can be configured using the “Certificate Templates” MMC Snap-In:</p>  <p><a href="/assets/archive/image_477.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_475.png" width="191" height="244" /></a> </p>  <p>NDES requires a challenge for every certificate transaction, unfortunately there seems to be no such setting in Cisco’s SCEP implementation. That default can be changed by setting the following registry key to “0”:</p>  <p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MSCEP\EnforcePassword\EnforcePassword</p>  <p>Warning: This disables the need for a challenge, so that essentially anyone with knowledge of your NDES server can enroll for certificates.</p>  <p>Restart the “certsvc” service after modifying the registry:</p>  <p><code>Get-Service certsvc | Restart-Service </code></p>  <h2>Configure NDES IIS settings</h2>  <p>IIS request filtering sets the value for MaxQueryString to 2048 by default, a reasonable key length is at least 1024, more often 2048. You see the problem, that value needs to be changed in order to support strong keys.</p>  <p>Use appcmd to change the value for MaxQueryString:</p>  <p>%systemroot%\system32\inetsrv\appcmd.exe set config /section:system.webServer/security/requestFiltering /requestLimits.maxQueryString:&quot;4096&quot; /commit:apphost</p>  <p>If you don’t update MaxQueryString you will see error 404.14 “Query string too long” in the IIS Log. </p>  <p>&#160;</p>  <p>There is a really good guide to NDES on <a href="http://social.technet.microsoft.com/wiki/contents/articles/9063.network-device-enrollment-service-ndes-in-active-directory-certificate-services-ad-cs.aspx" target="_blank">TechNet Wiki.</a>&#160;</p>  <p>That’s it for the first part, our NDES on Windows Server 2012 is configured and ready to go.</p>  <p>Stay tuned for part 2</p>  <p>&#160;</p>  <p>tom</p>
{% include imported_disclaimer.html %}
